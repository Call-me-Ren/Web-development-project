<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán - WatchTime</title>
  <style>
    :root{--blue:#2563eb;--muted:#6b7280;--bg:#f3f4f6}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, "Be Vietnam Pro", system-ui, sans-serif;background:var(--bg);color:#0f172a}
    .page{max-width:1100px;margin:18px auto;padding:12px}
    header {display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{color:var(--blue);font-size:22px;font-weight:800}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
    label{display:block;font-weight:700;margin-bottom:6px;font-size:14px}
    input,textarea,select{width:100%;padding:9px 10px;border:1px solid #e6e9ee;border-radius:8px;font-size:14px;background:#fff}
    textarea{min-height:84px;resize:vertical}
    .note{color:var(--muted);font-size:13px;margin-top:6px}
    .payment-methods{display:flex;gap:8px;flex-wrap:wrap}
    .pay-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid #eaeef6;cursor:pointer;background:#fff}
    .btn{display:inline-block;background:var(--blue);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:6px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    th{color:var(--muted);text-align:left;font-weight:700}
    td.price{text-align:right;width:110px}
    .summary-box{margin-top:12px;padding:12px;border-radius:10px;border:1px solid #f1f5f9;background:#fbfdff}
    .qr{display:block;margin:12px auto;max-width:260px;width:90%;height:auto;border-radius:8px}
    .hidden{display:none}
    .success{background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;padding:12px;border-radius:8px;margin-top:12px}
    .remove-btn{background:transparent;border:1px solid #f1f5f9;border-radius:6px;padding:6px 8px;cursor:pointer;color:#ef4444}
    .qty-control{display:flex;gap:6px;align-items:center}
    .qty-control button{width:30px;height:30px;border-radius:6px;border:1px solid #e6e9ee;background:#fff;cursor:pointer}
    @media (max-width:980px){ .grid{grid-template-columns:1fr 320px} }
    @media (max-width:820px){ .grid{grid-template-columns:1fr} .card{padding:12px} header{flex-direction:column;align-items:flex-start;gap:8px} }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div style="display:flex;gap:12px;align-items:center">
        <a href="index.html" id="backHomeBtn" class="btn btn-back" style="background:#111">Quay về trang chủ</a>
<div class="title">Thanh toán đơn hàng</div>
      </div>
      <div style="text-align:right">
        <div class="note">Giỏ hàng sẽ được lưu tự động trên trình duyệt (localStorage).</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Form -->
      <div>
        <div class="card" id="checkoutForm">
          <div style="margin-bottom:10px">
            <label for="name">Họ và tên</label>
            <input id="name" type="text" placeholder="Họ và tên người nhận">
          </div>

          <div style="margin-bottom:10px">
            <label for="phone">Số điện thoại</label>
            <input id="phone" type="tel" placeholder="Số điện thoại liên hệ">
          </div>

          <div style="margin-bottom:10px">
            <label for="address">Địa chỉ giao hàng <span class="note">(bỏ trống sẽ lấy địa chỉ trong tài khoản)</span></label>
            <textarea id="address" placeholder="Ví dụ: 123 Nguyễn Trãi, Quận 1, TP.HCM"></textarea>
            <div class="note">Nếu bạn đã đăng ký và lưu địa chỉ trong tài khoản, để trống ô trên sẽ tự điền địa chỉ đó.</div>
          </div>

          <div style="margin-bottom:10px">
            <label>Phương thức thanh toán</label>
            <div class="payment-methods" role="radiogroup">
              <label class="pay-pill"><input type="radio" name="payment" value="cod" checked> Tiền mặt khi nhận hàng (COD)</label>
              <label class="pay-pill"><input type="radio" name="payment" value="bank"> Chuyển khoản ngân hàng</label>
              <label class="pay-pill"><input type="radio" name="payment" value="online"> Thanh toán trực tuyến (QR)</label>
            </div>
          </div>

          <div id="formBankArea" class="hidden">
            <div class="summary-box">
              <div style="font-weight:700">Thông tin chuyển khoản (dự kiến)</div>
              <div class="note" style="margin-top:8px">Ngân hàng: <strong>Vietcombank</strong><br>Chủ TK: <strong>WATCHTIME JSC</strong><br>Số TK: <strong>0123456789</strong></div>
              <div style="margin-top:8px">
                <label for="formTransferRef">Ghi chú chuyển khoản (tùy chọn)</label>
                <input id="formTransferRef" placeholder="Ghi chú/ mã đơn hàng">
              </div>
            </div>
          </div>

          <div id="formOnlineArea" class="hidden">
            <div class="summary-box" style="text-align:center">
              <div style="font-weight:700;margin-bottom:6px">Thanh toán bằng QR (QR sẽ tạo khi Đặt hàng)</div>
              <div class="note">Sau khi bấm Đặt hàng, hệ thống sẽ sinh QR chứa số tiền cần thanh toán.</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="placeOrderBtn" class="btn">Đặt hàng</button>
<button id="useAccountBtn" class="btn btn-back" style="background:#6b7280">Dùng địa chỉ trong tài khoản</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: summary + editable cart -->
      <aside>
        <div class="card">
          <h3 style="margin:0 0 8px">Giỏ hàng</h3>

          <div id="cartEmptyNotice" class="summary-box hidden" style="text-align:center">
            <div style="font-weight:700">Giỏ hàng trống</div>
            <div class="note" style="margin-top:6px">Vui lòng thêm sản phẩm từ trang cửa hàng.</div>
            <div style="margin-top:10px"><a href="index.html" class="btn">Quay lại cửa hàng</a></div>
          </div>

          <table id="cartTable" class="hidden" aria-live="polite">
            <thead><tr><th>Sản phẩm</th><th style="text-align:center;width:120px">Số lượng</th><th class="price">Giá</th></tr></thead>
            <tbody id="cartBody"></tbody>
          </table>

          <div id="totalWrap" style="margin-top:10px;text-align:right;font-weight:800;display:none">
            Tổng tiền: <span id="totalPrice" style="color:crimson">0₫</span>
          </div>

          <div id="orderArea"></div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ======= Cấu hình ======= */
const CART_KEY = 'watchtime_cart'; // key localStorage
// Mô phỏng user account (nếu bạn có backend, thay bằng dữ liệu thật)
const account = { fullname: "Nguyễn Văn A", phone: "0901234567", savedAddress: "12A Nguyễn Huệ, Quận 1, TP.HCM" };

/* ======= Helpers lưu/đọc cart ======= */
function getCart(){
  try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
  catch(e){ return []; }
}
function saveCart(cart){
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  updateHeaderCartCount();
}
function sumCart(cart){ return cart.reduce((s,i)=> s + (i.price * i.qty), 0); }
function formatVND(n){ return Number(n).toLocaleString('vi-VN') + '₫'; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ======= Render cart UI (có thể chỉnh số lượng & xóa) ======= */
function renderCartUI(){
  const cart = getCart();
  const cartTable = document.getElementById('cartTable');
  const cartBody = document.getElementById('cartBody');
  const totalWrap = document.getElementById('totalWrap');
  const emptyNotice = document.getElementById('cartEmptyNotice');

  if(!cart || cart.length === 0){
    emptyNotice.classList.remove('hidden');
    cartTable.classList.add('hidden');
    totalWrap.style.display = 'none';
    return;
  }

  emptyNotice.classList.add('hidden');
  cartTable.classList.remove('hidden');
  cartBody.innerHTML = '';

  cart.forEach((item, idx) => {
    const tr = document.createElement('tr');

    // sản phẩm + remove button
    const tdName = document.createElement('td');
tdName.style.verticalAlign = 'middle';
    tdName.innerHTML = `<div style="font-weight:700">${escapeHtml(item.name)}</div>
                        <div class="note" style="margin-top:6px">Mã: ${escapeHtml(item.id || '')}</div>`;
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = 'Xóa';
    removeBtn.style.marginTop = '8px';
    removeBtn.onclick = () => {
      if(!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ?')) return;
      removeItemFromCart(idx);
    };
    tdName.appendChild(removeBtn);

    // số lượng với control
    const tdQty = document.createElement('td');
    tdQty.style.textAlign = 'center';
    tdQty.innerHTML = `<div class="qty-control">
      <button aria-label="Giảm" class="qty-minus">−</button>
      <div style="min-width:28px;text-align:center">${item.qty}</div>
      <button aria-label="Tăng" class="qty-plus">+</button>
    </div>`;
    // price
    const tdPrice = document.createElement('td');
    tdPrice.className = 'price';
    tdPrice.innerHTML = `${formatVND(item.price * item.qty)}`;

    tr.appendChild(tdName);
    tr.appendChild(tdQty);
    tr.appendChild(tdPrice);
    cartBody.appendChild(tr);

    // bind qty buttons
    const minus = tr.querySelector('.qty-minus');
    const plus = tr.querySelector('.qty-plus');
    minus.addEventListener('click', ()=>{
      if(item.qty > 1){
        item.qty -= 1;
        cart[idx] = item;
        saveCart(cart);
        renderCartUI();
      } else {
        // nếu qty =1 mà bấm giảm -> hỏi xóa
        if(confirm('Giảm sẽ xóa sản phẩm. Bạn muốn xóa không?')) {
          removeItemFromCart(idx);
        }
      }
    });
    plus.addEventListener('click', ()=>{
      item.qty += 1;
      cart[idx] = item;
      saveCart(cart);
      renderCartUI();
    });
  });

  // total
  const total = sumCart(cart);
  document.getElementById('totalPrice').textContent = formatVND(total);
  totalWrap.style.display = 'block';
}

/* Xóa theo index */
function removeItemFromCart(index){
  const cart = getCart();
  if(index >=0 && index < cart.length){
    cart.splice(index,1);
    saveCart(cart);
    renderCartUI();
  }
}

/* Cập nhật cart-count ở header (nếu có phần tử) */
function updateHeaderCartCount(){
  const cart = getCart();
  const count = cart.reduce((s,i)=> s + (i.qty || 0), 0);
  const el = document.getElementById('cart-count');
  if(el) el.textContent = count;
}

/* ======= Payment UI handling & Order flow ======= */
const radios = document.querySelectorAll('input[name="payment"]');
const formBankArea = document.getElementById('formBankArea');
const formOnlineArea = document.getElementById('formOnlineArea');

function updateFormPaymentUI(){
  const val = document.querySelector('input[name="payment"]:checked').value;
  formBankArea.classList.toggle('hidden', val !== 'bank');
formOnlineArea.classList.toggle('hidden', val !== 'online');
}
radios.forEach(r=> r.addEventListener('change', updateFormPaymentUI));
updateFormPaymentUI();

/* Dùng địa chỉ tài khoản */
document.getElementById('useAccountBtn').addEventListener('click', ()=>{
  document.getElementById('name').value = account.fullname;
  document.getElementById('phone').value = account.phone;
  document.getElementById('address').value = account.savedAddress;
});

/* Đặt hàng */
document.getElementById('placeOrderBtn').addEventListener('click', function(){
  const cart = getCart();
  if(!cart || cart.length === 0){
    alert('Giỏ hàng rỗng. Vui lòng thêm sản phẩm trước khi đặt hàng.');
    return;
  }
  const name = document.getElementById('name').value.trim() || account.fullname;
  const phone = document.getElementById('phone').value.trim() || account.phone;
  let address = document.getElementById('address').value.trim() || account.savedAddress || '';
  if(!address){
    alert('Vui lòng nhập địa chỉ nhận hàng hoặc dùng địa chỉ trong tài khoản.');
    return;
  }
  const payment = document.querySelector('input[name="payment"]:checked').value;
  const order = {
    id: 'ORD' + Date.now(),
    customer: { name, phone, address },
    items: cart,
    total: sumCart(cart),
    paymentMethod: payment
  };
  showOrderSummary(order);
});

/* Hiển thị tóm tắt đơn hàng + payment flows (giữ nguyên khả năng tạo QR) */
function showOrderSummary(order){
  const orderArea = document.getElementById('orderArea');
  orderArea.innerHTML = '';
  // summary
  const s = document.createElement('div'); s.className = 'summary-box';
  s.innerHTML = `<div style="font-weight:800">Đơn hàng #${order.id}</div>
    <div style="margin-top:8px"><strong>Người nhận:</strong> ${escapeHtml(order.customer.name)} — ${escapeHtml(order.customer.phone)}</div>
    <div style="margin-top:6px"><strong>Địa chỉ:</strong> ${escapeHtml(order.customer.address)}</div>
    <div style="margin-top:8px"><strong>Sản phẩm:</strong><ul id="orderItems" style="margin:6px 0 0 16px;padding-left:0;"></ul></div>
    <div style="text-align:right;margin-top:8px;font-weight:800">Tổng: <span style="color:crimson">${formatVND(order.total)}</span></div>`;
  orderArea.appendChild(s);

  const ul = s.querySelector('#orderItems');
  order.items.forEach(it=>{
    const li = document.createElement('li');
    li.textContent = `${it.name} x ${it.qty} — ${formatVND(it.price * it.qty)}`;
    ul.appendChild(li);
  });

  if(order.paymentMethod === 'online'){
    const qrDiv = document.createElement('div'); qrDiv.className = 'summary-box';
    const qrUrl = generateQrUrl(`ONLINE|order=${order.id}|amount=${order.total}`);
    qrDiv.innerHTML = `<div style="font-weight:700">Thanh toán trực tuyến</div>
<div class="note" style="margin-top:6px">Quét mã QR để thanh toán số tiền: <strong>${formatVND(order.total)}</strong></div>
      <img src="${qrUrl}" class="qr" alt="QR thanh toán">`;
    orderArea.appendChild(qrDiv);

    const ok = document.createElement('button'); ok.className = 'btn'; ok.textContent = 'Hoàn tất';
    ok.style.marginTop = '10px';
    ok.onclick = ()=>{
      alert('Quét QR và thực hiện thanh toán. Đơn hàng đã được ghi nhận.');
      localStorage.removeItem(CART_KEY);
      updateHeaderCartCount();
      renderCartUI();
      orderArea.innerHTML = '<div class="success">Cảm ơn! Đơn hàng đã được ghi nhận.</div>';
    };
    orderArea.appendChild(ok);

  } else if(order.paymentMethod === 'bank'){
    const bankDiv = document.createElement('div'); bankDiv.className = 'summary-box';
    bankDiv.innerHTML = `<div style="font-weight:700">Chuyển khoản ngân hàng</div>
      <div class="note" style="margin-top:6px">Ngân hàng: <strong>Vietcombank</strong><br>Chủ TK: <strong>WATCHTIME JSC</strong><br>Số TK: <strong>0123456789</strong></div>
      <div style="margin-top:8px">
        <label>Số tiền bạn đã chuyển (VNĐ)</label>
        <input id="summaryTransferAmount" type="number" placeholder="Ví dụ: 458500000">
        <label style="margin-top:8px">Mã giao dịch (nếu có)</label>
        <input id="summaryTransferRef" type="text" placeholder="Mã giao dịch / ghi chú">
        <button id="createBankQrBtn" class="btn" style="margin-top:8px">Tạo QR chuyển khoản</button>

        <div id="bankQrWrap" class="hidden" style="text-align:center;margin-top:10px">
          <div class="note">QR chuyển khoản (chứa: order, tài khoản, số tiền, mã)</div>
          <img id="bankQrImg" class="qr" src="#" alt="QR chuyển khoản">
        </div>

        <div style="margin-top:8px"><button id="bankFinalBtn" class="btn" style="margin-top:8px">Hoàn tất</button></div>
      </div>`;
    orderArea.appendChild(bankDiv);

    setTimeout(()=>{
      document.getElementById('createBankQrBtn').onclick = ()=>{
        const amt = Number(document.getElementById('summaryTransferAmount').value);
        const ref = document.getElementById('summaryTransferRef').value.trim();
        if(!amt || amt <= 0){ alert('Vui lòng nhập số tiền đã chuyển.'); return; }
        const acct = 'VCB-0123456789';
        const data = `BANK|order=${order.id}|acct=${acct}|amount=${amt}|ref=${encodeURIComponent(ref)}`;
        document.getElementById('bankQrImg').src = generateQrUrl(data);
        document.getElementById('bankQrWrap').classList.remove('hidden');
      };
      document.getElementById('bankFinalBtn').onclick = ()=>{
        alert('Cảm ơn! Đơn hàng được ghi nhận.'); 
        localStorage.removeItem(CART_KEY);
        updateHeaderCartCount();
        renderCartUI();
orderArea.innerHTML = '<div class="success">Cảm ơn! Đơn hàng đã được ghi nhận.</div>';
      };
    }, 50);

  } else {
    const codDiv = document.createElement('div'); codDiv.className = 'summary-box';
    codDiv.innerHTML = `<div style="font-weight:700">Thanh toán khi nhận hàng (COD)</div><div class="note" style="margin-top:6px">Người bán sẽ liên hệ để xác nhận đơn.</div>`;
    orderArea.appendChild(codDiv);
    const ok = document.createElement('button'); ok.className = 'btn'; ok.textContent='Hoàn tất'; ok.style.marginTop='10px';
    ok.onclick = ()=>{
      alert('Đơn hàng COD đã được ghi nhận.');
      localStorage.removeItem(CART_KEY);
      updateHeaderCartCount();
      renderCartUI();
      orderArea.innerHTML = '<div class="success">Cảm ơn! Đơn hàng đã được ghi nhận.</div>';
    };
    orderArea.appendChild(ok);
  }

  setTimeout(()=> orderArea.scrollIntoView({behavior:'smooth'}),200);
}

/* ======= Khởi tạo trang ======= */
function generateQrUrl(text){ return 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(text); }

document.addEventListener('DOMContentLoaded', ()=>{
  renderCartUI();
  updateHeaderCartCount();

  // khi bấm quay về trang chủ — localStorage không bị xóa => cart vẫn giữ
  document.getElementById('backHomeBtn').addEventListener('click', ()=> {
    // chỉ điều hướng bằng href, cart giữ nguyên trong localStorage
    // (nếu muốn có hành vi khác, thêm ở đây)
  });
});
</script>
</body>
</html>
