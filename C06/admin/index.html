<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - WatchTime</title>
    <link rel="stylesheet" href="../css/admin.css"> 
</head>
<body>
    <div class="login-container">
        <form id="form-admin-login" class="login-form">
            <h2>Admin WatchTime</h2>
            <p>Đăng nhập vào trang quản trị</p>
            
            <div id="error-message" class="error-message hidden"></div>

            <div class="input-group">
                <label for="admin-user">Tên đăng nhập</label>
                <input type="text" id="admin-user" required>
            </div>
            
            <div class="input-group">
                <label for="admin-pass">Mật khẩu</label>
                <input type="password" id="admin-pass" required>
            </div>
            
            <button type="submit" class="login-button">Đăng nhập</button>
        </form>
    </div>

    <script src="../js/admin.js"></script> 

    <script>
        document.getElementById("form-admin-login").addEventListener("submit", function(e) {
            e.preventDefault();
            
            const username = document.getElementById("admin-user").value.trim();
            const pass = document.getElementById("admin-pass").value.trim();
            const errorMsg = document.getElementById("error-message");

            errorMsg.classList.add("hidden");

            if (!username || !pass) {
                 errorMsg.textContent = "Vui lòng nhập đầy đủ Tên đăng nhập và Mật khẩu!";
                 errorMsg.classList.remove("hidden");
                 return;
            }
            
            let storedUserData = null;
            let loginSuccess = false;
            
            // =========================================================
            // --- BƯỚC 1: KIỂM TRA HARDCODE ADMIN GỐC (TUYỆT ĐỐI) ---
            // =========================================================
            const DEFAULT_ADMIN_USERNAME = 'quanly1';
            const DEFAULT_ADMIN_PASSWORD = 'abcd1234';

            if (username === DEFAULT_ADMIN_USERNAME && pass === DEFAULT_ADMIN_PASSWORD) {
                // Đăng nhập Admin gốc thành công, KHÔNG CẦN CHECK LOCAL STORAGE.
                loginSuccess = true;
                storedUserData = { isAdmin: true }; // Gán giá trị Admin cố định
            } else {
                
                // =================================================================
                // --- BƯỚC 2: KIỂM TRA ADMIN/USER KHÁC (CẦN LOCAL STORAGE) ---
                // =================================================================
                const possibleKeys = [username, `${username}_admin`]; 
                
                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const user = JSON.parse(data);
                            
                            // Kiểm tra Mật khẩu, cờ isAdmin, tên đăng nhập khớp
                            if (user.password === pass && (user.isAdmin === true || user.key === username) && user.username === username) { 
                                if (user.isLocked === true) {
                                     errorMsg.textContent = `Tài khoản '${username}' đã bị khóa!`;
                                     errorMsg.classList.remove("hidden");
                                     return;
                                }
                                storedUserData = user;
                                loginSuccess = true;
                                break;
                            }
                        } catch (e) {
                            console.error(`Lỗi parse dữ liệu cho key ${key}:`, e);
                        }
                    }
                }
            }
            
            // --- KẾT QUẢ ĐĂNG NHẬP ---
            if (loginSuccess) {
                // Đăng nhập thành công
                // Xác định là Admin hay User để lưu Session
                const isAdmin = storedUserData && storedUserData.isAdmin;
                sessionStorage.setItem("isAdminLoggedIn", isAdmin ? "true" : "false"); 
                
                if(isAdmin) {
                    alert("Đăng nhập Admin thành công!");
                    window.location.href = "dashboard.html"; 
                } else {
                     alert(`Đăng nhập thành công với tài khoản ${username}!`);
                     // Giả định trang Client là index_client.html (Lùi 1 cấp từ admin/ ra ngoài)
                     window.location.href = "../index_client.html"; 
                }
                
            } else {
                // Đăng nhập thất bại
                errorMsg.textContent = "Sai Tên đăng nhập hoặc Mật khẩu, hoặc Tài khoản không tồn tại!";
                errorMsg.classList.remove("hidden");
            }
        });
    </script>
</body>
</html>