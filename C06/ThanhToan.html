<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Thanh toán - WatchTime</title>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --brand:#2563eb; --accent:#111827; --danger:#ef4444;
  --radius:12px; --gap:14px; --shadow:0 6px 20px rgba(2,6,23,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Be Vietnam Pro',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0f172a;background:var(--bg);-webkit-font-smoothing:antialiased}
a{color:inherit}
.page{max-width:1100px;margin:12px auto;padding:12px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{margin:0;font-size:18px;color:var(--brand);font-weight:800}
.grid{display:block;gap:16px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
label{display:block;font-weight:600;margin-bottom:8px;font-size:14px;color:#0f172a}
input,textarea,select{width:100%;padding:12px;border:1px solid #e6e9ee;border-radius:10px;font-size:15px;background:#fff}
textarea{min-height:88px;resize:vertical}
.note{color:var(--muted);font-size:13px;margin-top:8px}
.payment-methods{display:flex;gap:8px;flex-wrap:wrap}
.pay-pill{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:1px solid #eef2ff;cursor:pointer;background:#fff;min-width:140px}
.pay-pill input{margin:0}
.cart-list{display:flex;flex-direction:column;gap:10px}
.cart-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #f1f5f9}
.cart-item .meta{flex:1}
.cart-item .price{text-align:right;min-width:80px;font-weight:700}
.btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn.secondary{background:#111;color:#fff}
.btn.ghost{background:transparent;border:1px solid #e6e9ee;color:var(--accent)}
.remove-btn{background:transparent;border:1px solid #f1f5f9;border-radius:8px;padding:6px 8px;cursor:pointer;color:var(--danger)}
.qty{display:inline-flex;align-items:center;border-radius:8px;border:1px solid #e6e9ee;overflow:hidden}
.qty button{background:#fff;border:none;padding:8px 10px;cursor:pointer}
.qty .count{min-width:28px;text-align:center;padding:8px}
#totalWrap{margin-top:12px;text-align:right;display:none;align-items:center;justify-content:space-between}
#totalWrap .total-label{color:var(--muted);font-size:13px}
#totalWrap .total-amount{font-weight:800;font-size:18px;color:crimson}
.icon-btn{display:inline-flex;align-items:center;justify-content:center;padding:8px;border-radius:10px}
.empty{padding:18px;text-align:center;border-radius:10px}
.muted{color:var(--muted)}
.hidden{display:none}
.qr-img{max-width:320px;width:90%;height:auto;border-radius:8px;border:8px solid #fff;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:block;margin:12px auto}
#orderSummaryArea{margin-top:20px} /* New style for summary area */

@media(min-width:820px){.grid{display:grid;grid-template-columns:1fr 360px;gap:20px}.bottom-summary{display:none}header{align-items:center}.page{margin-top:18px}}
@media(max-width:820px){
  body{background:#f9fafb}
  .page{padding:8px}
  header{flex-direction:column;align-items:flex-start;gap:6px}
  header h1{font-size:16px}
  .brand a{font-size:14px}
  .card{padding:12px;border-radius:10px}
  label{font-size:13px;margin-bottom:6px}
  input,textarea,select{padding:10px;font-size:14px}
  textarea{min-height:70px}
  .payment-methods{display:flex;gap:6px;flex-wrap:wrap;justify-content:space-around}
  .pay-pill{min-width:unset;flex-grow:1;display:block;text-align:center;white-space:normal;padding:8px 6px}
  .pay-pill input{display:inline-block;margin-right:4px}
  .cart-item{flex-direction:column;align-items:flex-start}
  .cart-item .meta{width:100%}
  .cart-item .price{text-align:left}
  #totalWrap{font-size:15px;display:flex !important;position:fixed;left:12px;right:12px;bottom:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);justify-content:space-between;align-items:center;z-index:1000}
  #cartCard{padding-bottom:86px}
  #cartCard .muted,#cartCard .small-label{display:none}
  #mobileOrderArea .card{margin-top:10px;padding:14px}
  .qr-img{width:100%;max-width:280px}
  .card,#totalWrap{box-shadow:0 4px 12px rgba(0,0,0,0.06)}
  #orderSummaryArea{margin-bottom:100px} /* Add margin bottom to avoid overlap with totalWrap */
}
</style>
</head>
<body>
<div class="page">
<header>
<div class="brand">
<a href="index.html" aria-label="Quay về trang chủ" class="icon-btn">⟵ Quay về trang chủ</a>
<h1>Thanh toán đơn hàng</h1>
</div>
</header>

<div class="grid">
<div>
<div class="card" id="checkoutForm">
<div style="display:flex;gap:12px;flex-direction:column">

  <div id="recipientSelectArea" style="margin-bottom:12px">
    <label for="recipient">Người nhận & Địa chỉ</label>
    <select id="recipient" class="w-full rounded-lg border border-gray-300 p-2"></select>
  </div>

  <div>
    <label for="name">Họ và tên</label>
    <input id="name" type="text" placeholder="Họ và tên người nhận" autocomplete="name">
  </div>
  <div>
    <label for="phone">Số điện thoại</label>
    <input id="phone" type="tel" placeholder="Số điện thoại liên hệ" autocomplete="tel">
  </div>
  <div>
    <label for="address">Địa chỉ giao hàng</label>
<textarea id="address" placeholder="Ví dụ: 123 Nguyễn Trãi, Quận 1, TP.HCM"></textarea>
<div class="note">Để trống để dùng địa chỉ đã lưu trong tài khoản (nếu có).</div>
  </div>

  <div>
    <label>Phương thức thanh toán</label>
    <div class="payment-methods" role="radiogroup">
      <label class="pay-pill"><input type="radio" name="payment" value="cod" checked> Tiền mặt (COD)</label>
      <label class="pay-pill"><input type="radio" name="payment" value="bank"> Chuyển khoản</label>
      <label class="pay-pill"><input type="radio" name="payment" value="online"> Thanh toán QR</label>
    </div>
  </div>

  <div style="margin-top:12px">
    <button id="placeOrderBtnMobile" class="btn" style="width:100%">Đặt hàng</button>
  </div>

  <div id="formBankArea" class="card hidden" style="padding:12px;margin-top:12px">
    <div style="font-weight:700">Thông tin chuyển khoản</div>
    <div class="note" style="margin-top:8px">Ngân hàng: <strong>Vietcombank</strong><br>Chủ TK: <strong>WATCHTIME JSC</strong><br>Số TK: <strong>0123456789</strong></div>
    <div style="margin-top:8px">
      <label for="formTransferRef">Ghi chú (mã giao dịch)</label>
      <input id="formTransferRef" placeholder="Ghi chú / Mã đơn hàng">
    </div>
  </div>

  <div id="formQrArea" class="card hidden" style="padding:12px;margin-top:12px;text-align:center">
      <div style="font-weight:700">Quét mã QR để thanh toán</div>
      <img src="images/qr.jpg" alt="Mã QR thanh toán" class="qr-img"> 
      <div class="note" style="margin-top:8px">Nội dung chuyển khoản: <strong id="qrContent"></strong></div>
  </div>
</div>
</div>

<div id="orderSummaryArea" class="card hidden">
    <h3 style="margin-top:0; color:var(--brand)">✅ Đặt hàng thành công!</h3>
    <div style="margin-bottom:8px"><strong>Mã đơn:</strong> <span id="summaryOrderId"></span></div>
    <div style="margin-bottom:4px"><strong>Ngày đặt:</strong> <span id="summaryDateTime"></span></div>
    <div style="margin-bottom:4px"><strong>Người nhận:</strong> <span id="summaryCustomerName"></span></div>
    <div style="margin-bottom:4px"><strong>Địa chỉ:</strong> <span id="summaryAddress"></span></div>
    <div style="margin-bottom:12px"><strong>SĐT:</strong> <span id="summaryPhone"></span></div>
    
    <div style="font-weight:700; margin-bottom:8px">Sản phẩm:</div>
    <div id="summaryItemsList" style="margin-bottom:12px; border-top:1px solid #eee; padding-top:8px;"></div>
    
    <div style="display:flex;justify-content:space-between;align-items:center; border-top:1px solid #eee; padding-top:12px">
      <div><strong>Phương thức:</strong> <span id="summaryPayment"></span></div>
      <div style="font-weight:800; font-size:18px; color:crimson" id="summaryTotal"></div>
    </div>
</div>
<div id="mobileOrderArea" style="margin-top:12px"></div>
</div>

<aside>
<div class="card" id="cartCard">
<h3 style="margin:0 0 8px">Giỏ hàng</h3>
<div id="cartEmptyNotice" class="empty muted hidden">Giỏ hàng trống</div>
<div id="cartList" class="cart-list"></div>
<div id="totalWrap">
  <div style="display:flex;flex-direction:column;align-items:flex-end">
    <div class="total-label">Tổng tiền</div>
    <div class="total-amount" id="totalPrice">0₫</div>
  </div>
  <div style="margin-left:12px"><button id="checkoutBtnDesktop" class="btn">Đặt hàng</button></div>
</div>
</div>
</aside>
</div>
</div>

<script>
// === STORAGE KEYS ===
const CART_KEY='watchtime_cart';
const ORDERS_KEY='allOrders';
const IMPORTS_KEY='watchtime_imports';

// === HELPERS ===
function getStorageData(key, def) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : (def===undefined?[]:def); } catch(e) { return def===undefined?[]:def; } }
function saveStorageData(key, v){ localStorage.setItem(key, JSON.stringify(v)); }
function getCart(){ return getStorageData(CART_KEY, []); }
function saveCart(c){ saveStorageData(CART_KEY, c); renderCartUI(); }
function sumCart(c){ return (c||[]).reduce((s,i)=>s + (Number(i.price)||0) * (i.qty||1), 0); }
function formatVND(n){ return Number(n).toLocaleString('vi-VN') + '₫'; }
function e(s){ return String(s||'').replace(/[&<>"']/g, ''); }

// === INVENTORY ===
function calculateAllInventory(){
    
    // --- ĐÃ THÊM: KHỞI TẠO DỮ LIỆU NHẬP HÀNG GIẢ ĐỊNH NẾU CHƯA CÓ ---
    // Điều này đảm bảo tồn kho ban đầu > 0 cho các sản phẩm trong giỏ hàng demo
    if (!localStorage.getItem(IMPORTS_KEY) || getStorageData(IMPORTS_KEY).length === 0) {
        const mockImport = {
            id: 'IMP' + Date.now().toString().slice(-10),
            status: 'Đã hoàn thành',
            items: [
                // Thêm tồn kho 100 cho sản phẩm Đồng hồ OIP
                { id: 'sp_oip', name: 'Đồng hồ OIP', qty: 100, price: 4000000 }
                // Nếu có sản phẩm khác, thêm vào đây: { id: 'mã_sp', name: 'Tên SP', qty: 50, price: ... }
            ],
            createdAt: new Date().toISOString()
        };
        saveStorageData(IMPORTS_KEY, [mockImport]);
    }
    // ------------------------------------------------------------------

    const imports = getStorageData(IMPORTS_KEY, []).filter(i=>i.status==='Đã hoàn thành');
    const orders = getStorageData(ORDERS_KEY, []).filter(o=>o.status==='Đã giao');
    const inventory = new Map();

    // gather all product ids from imports/orders/cart
    const ids = new Set();
    imports.forEach(imp => imp.items && imp.items.forEach(it => ids.add(it.productId || it.id)));
    orders.forEach(o => o.items && o.items.forEach(it => ids.add(it.productId || it.id)));
    getCart().forEach(i => ids.add(i.id));

    ids.forEach(id => {
        let inQty = 0, outQty = 0;
        imports.forEach(imp => { const it = imp.items && imp.items.find(i => (i.productId||i.id)===id); if(it) inQty += (it.qty||0); });
        orders.forEach(o => { const it = o.items && o.items.find(i => (i.id||i.productId)===id); if(it) outQty += (it.qty||0); });
        inventory.set(id, Math.max(0, inQty - outQty));
    });
    return inventory;
}

// === RENDER CART ===
function renderCartUI(){
    const cart = getCart();
    const cartList = document.getElementById('cartList');
    const empty = document.getElementById('cartEmptyNotice');
    const totalWrap = document.getElementById('totalWrap');
    const totalPrice = document.getElementById('totalPrice');
    const inventory = calculateAllInventory();

    cartList.innerHTML = '';
    if(!cart.length){ empty.classList.remove('hidden'); totalWrap.style.display='none'; totalPrice.textContent='0₫'; return; }
    empty.classList.add('hidden');

    cart.forEach((it, idx) => {
        const div = document.createElement('div'); div.className='cart-item';
        div.innerHTML = `
<div class="meta"><div style="font-weight:700">${e(it.name)}</div><div class="muted" style="font-size:13px;margin-top:6px">Mã: ${e(it.id||'')}</div></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px"><div class="price">${formatVND((it.price||0)*it.qty)}</div>
            <div style="display:flex;gap:6px;align-items:center"><div class="qty"><button data-action="dec">−</button><div class="count">${it.qty}</div><button data-action="inc">+</button></div><button class="remove-btn">Xóa</button></div></div>
        `;
        cartList.appendChild(div);

        div.querySelector('[data-action="dec"]').addEventListener('click', ()=>{
            const current = getCart();
            if(current[idx].qty > 1){ current[idx].qty--; saveCart(current); }
            else if(confirm('Giảm sẽ xóa sản phẩm. Xóa?')){ current.splice(idx,1); saveCart(current); }
        });
        div.querySelector('[data-action="inc"]').addEventListener('click', ()=>{
            const stock = inventory.get(it.id) || 0;
            const newQty = it.qty + 1;
            if(newQty > stock){ alert(`Sản phẩm "${it.name}" chỉ còn ${stock}`); }
            else { const current = getCart(); current[idx].qty++; saveCart(current); }
        });
        div.querySelector('.remove-btn').addEventListener('click', ()=>{ if(confirm('Xóa sản phẩm?')){ const current = getCart(); current.splice(idx,1); saveCart(current); } });
    });

    totalPrice.textContent = formatVND(sumCart(cart));
    totalWrap.style.display = 'flex';
}

// === RECIPIENTS ===
function initializeRecipientSelect(){
    const select = document.getElementById('recipient'); if(!select) return;
    select.innerHTML = '';

    const currentUser = getStorageData('currentUser', null);
    const subAccounts = getStorageData('subAccounts', []);
    const allRegisteredUsers = getStorageData('registeredUsers', []);

    if(currentUser && currentUser.address){
        const opt = document.createElement('option'); opt.value='default_user';
        const fullName = `${currentUser.firstname||''} ${currentUser.lastname||''}`.trim();
        opt.textContent = `Địa chỉ của tôi: ${fullName ? fullName + ' — ' : ''}${currentUser.address}`;
        select.appendChild(opt);
    }

    subAccounts.forEach((sub, idx) => { if(sub.name && sub.address){ const opt=document.createElement('option'); opt.value=`sub_${idx}`; opt.textContent=`Tài khoản phụ: ${sub.name} — ${sub.address}`; select.appendChild(opt); } });

    allRegisteredUsers.forEach((user, idx) => { if(user.address){ const opt=document.createElement('option'); opt.value=`reg_user_${idx}`; opt.textContent = `${user.name} — ${user.address}`; select.appendChild(opt); } });

    const optNew = document.createElement('option'); optNew.value='new_input'; optNew.textContent='Nhập thông tin người nhận mới'; select.appendChild(optNew);
select.addEventListener('change', handleRecipientChange);
handleRecipientChange();
}

function handleRecipientChange(){
    const select = document.getElementById('recipient'); if(!select) return;
    const val = select.value;
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const addressInput = document.getElementById('address');

    nameInput.disabled = phoneInput.disabled = addressInput.disabled = false;
    nameInput.value = phoneInput.value = addressInput.value = '';

    const currentUser = getStorageData('currentUser', null);
    const subAccounts = getStorageData('subAccounts', []);
    const allRegisteredUsers = getStorageData('registeredUsers', []);

    if(val === 'default_user' && currentUser){
        nameInput.value = `${currentUser.firstname||''} ${currentUser.lastname||''}`.trim();
        phoneInput.value = currentUser.number || '';
        addressInput.value = currentUser.address || '';
        nameInput.disabled = phoneInput.disabled = addressInput.disabled = true;
    } else if(val.startsWith('sub_')){
        const idx = parseInt(val.split('_')[1], 10);
        const sub = subAccounts[idx]; if(sub){ nameInput.value=sub.name; phoneInput.value=sub.phone||''; addressInput.value=sub.address||''; nameInput.disabled=phoneInput.disabled=addressInput.disabled=true; }
    } else if(val.startsWith('reg_user_')){
        const idx = parseInt(val.split('_')[2], 10);
        const user = allRegisteredUsers[idx]; if(user){ nameInput.value=user.name; phoneInput.value=user.number||''; addressInput.value=user.address||''; nameInput.disabled=phoneInput.disabled=addressInput.disabled=true; }
    }
}

// === PAYMENT UI ===
let selectedPayment = 'cod';
function setupPaymentListeners(){
    document.querySelectorAll('input[name="payment"]').forEach(r => r.addEventListener('change', ()=>{
        selectedPayment = document.querySelector('input[name="payment"]:checked').value;
        document.getElementById('formBankArea').classList.add('hidden');
        document.getElementById('formQrArea').classList.add('hidden');
        if(selectedPayment === 'bank') document.getElementById('formBankArea').classList.remove('hidden');
        if(selectedPayment === 'online') document.getElementById('formQrArea').classList.remove('hidden');
        // Ẩn tóm tắt đơn hàng khi thay đổi phương thức thanh toán
        document.getElementById('orderSummaryArea').classList.add('hidden');
    }));
}

// === ORDER BUILD & SHOW ===
function buildOrder(){
    const cart = getCart(); if(!cart.length){ alert('Giỏ hàng trống'); return null; }

    const inventory = calculateAllInventory();
    
    // --- ĐÃ SỬA: KHÔI PHỤC LOGIC CHẶN ĐẶT HÀNG NẾU KHÔNG ĐỦ TỒN KHO ---
    // Vì đã thêm Mock Data, nên logic này sẽ hoạt động chính xác.
    for(const item of cart){ 
        const stock = inventory.get(item.id) || 0; 
        if(item.qty > stock){ 
            alert(`Sản phẩm "${item.name}" chỉ còn ${stock} sản phẩm trong kho!`); 
            return null; 
        } 
    }
    // ------------------------------------------------------------------

    const name = document.getElementById('name').value.trim();
const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    if(!name || !phone || !address){ alert('Vui lòng nhập đầy đủ Họ tên, SĐT, Địa chỉ'); return null; }
const pm = document.querySelector('input[name="payment"]:checked').value;
    const currentUser = getStorageData('currentUser', null);

    return {
        id: 'ORD' + Date.now().toString().slice(-10), // Rút gọn ID cho dễ nhìn
        userEmail: currentUser ? currentUser.email : 'guest',
        customer: { name, phone, address },
        items: cart.map(i => ({ ...i })),
        total: sumCart(cart),
        paymentMethod: pm,
        status: 'Mới đặt',
        createdAt: new Date().toISOString()
    };
}

// Hàm mới để hiển thị tóm tắt đơn hàng ngay trên trang
function renderOrderSummary(order){
    if(order.paymentMethod === 'online') document.getElementById('qrContent').textContent = `WATCHTIME.${order.id}`;

    document.getElementById('summaryOrderId').textContent = order.id;
    document.getElementById('summaryCustomerName').textContent = order.customer.name;
    document.getElementById('summaryAddress').textContent = order.customer.address;
    document.getElementById('summaryPhone').textContent = order.customer.phone;
    document.getElementById('summaryDateTime').textContent = new Date(order.createdAt).toLocaleString('vi-VN');
    
    let paymentText = '';
    switch(order.paymentMethod){
        case 'cod': paymentText = 'Tiền mặt (COD)'; break;
        case 'bank': paymentText = 'Chuyển khoản'; break;
        case 'online': paymentText = 'Thanh toán QR'; break;
    }
    document.getElementById('summaryPayment').textContent = paymentText;
    document.getElementById('summaryTotal').textContent = formatVND(order.total);

    const itemsList = document.getElementById('summaryItemsList'); itemsList.innerHTML = '';
    order.items.forEach(item => {
        const itemDiv = document.createElement('div'); itemDiv.style.marginBottom = '6px';
        itemDiv.innerHTML = `<div style="font-weight:600">${e(item.name)}</div><div style="display:flex;justify-content:space-between;color:var(--muted);font-size:13px"><span>Mã: ${e(item.id)} | Số lượng: ${item.qty}</span><span>${formatVND(item.price*item.qty)}</span></div>`; 
        itemsList.appendChild(itemDiv);
    });

    document.getElementById('orderSummaryArea').classList.remove('hidden');

    
}


function showOrderSummary(order){
    const allOrders = getStorageData(ORDERS_KEY, []);
    allOrders.push(order); saveStorageData(ORDERS_KEY, allOrders);
    
    localStorage.removeItem(CART_KEY); // Xóa giỏ hàng sau khi đặt thành công
    renderCartUI(); // Cập nhật lại giao diện giỏ hàng

    // Thay thế Modal bằng việc hiển thị thông tin ngay dưới form
    renderOrderSummary(order);
}

// === INIT ===
document.addEventListener('DOMContentLoaded', ()=>{
    
    // Tải lại dữ liệu tồn kho giả định (nếu cần) trước khi render giỏ hàng
    calculateAllInventory(); 
    
    renderCartUI();
    initializeRecipientSelect();
    setupPaymentListeners();

    // Thay thế logic pop-up bằng gọi showOrderSummary trực tiếp
    document.getElementById('checkoutBtnDesktop')?.addEventListener('click', ()=>{ 
        const o = buildOrder(); 
        if(o) showOrderSummary(o); 
    });
    document.getElementById('placeOrderBtnMobile')?.addEventListener('click', ()=>{ 
        const o = buildOrder(); 
        if(o) showOrderSummary(o); 
    });
});
</script>
</body>
</html>