<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán - WatchTime</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --brand:#2563eb; --accent:#111827; --danger:#ef4444;
      --radius:12px; --gap:14px; --shadow:0 6px 20px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Be Vietnam Pro',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#0f172a;background:var(--bg);-webkit-font-smoothing:antialiased}
    a{color:inherit}
    .page{max-width:1100px;margin:12px auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{margin:0;font-size:18px;color:var(--brand);font-weight:800}
    .grid{display:block;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    label{display:block;font-weight:600;margin-bottom:8px;font-size:14px;color:#0f172a}
    input,textarea,select{width:100%;padding:12px;border:1px solid #e6e9ee;border-radius:10px;font-size:15px;background:#fff}
    textarea{min-height:88px;resize:vertical}
    .note{color:var(--muted);font-size:13px;margin-top:8px}
    .payment-methods{display:flex;gap:8px;flex-wrap:wrap}
    .pay-pill{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:1px solid #eef2ff;cursor:pointer;background:#fff;min-width:140px}
    .pay-pill input{margin:0}
    .cart-list{display:flex;flex-direction:column;gap:10px}
    .cart-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;border:1px solid #f1f5f9}
    .cart-item .meta{flex:1}
    .cart-item .price{text-align:right;min-width:80px;font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:#111;color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6e9ee;color:var(--accent)}
    .remove-btn{background:transparent;border:1px solid #f1f5f9;border-radius:8px;padding:6px 8px;cursor:pointer;color:var(--danger)}
    .qty{display:inline-flex;align-items:center;border-radius:8px;border:1px solid #e6e9ee;overflow:hidden}
    .qty button{background:#fff;border:none;padding:8px 10px;cursor:pointer}
    .qty .count{min-width:28px;text-align:center;padding:8px}
    #totalWrap{margin-top:12px;text-align:right}
    #totalWrap .total-label{color:var(--muted);font-size:13px}
    #totalWrap .total-amount{font-weight:800;font-size:18px;color:crimson}
    @media(min-width:820px){
      .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
      .bottom-summary{display:none}
      header{align-items:center}
      .page{margin-top:18px}
    }
    @media(max-width:820px){
      .bottom-summary{display:none !important}
      #totalWrap{display:flex !important;position:fixed;left:12px;right:12px;bottom:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);justify-content:space-between;align-items:center;z-index:1000}
      #cartCard{padding-bottom:86px}
      #cartCard .muted, #cartCard .small-label{display:none}
    }
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;padding:8px;border-radius:10px}
    .empty{padding:18px;text-align:center;border-radius:10px}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .qr-img{max-width:320px;width:90%;height:auto;border-radius:8px;border:8px solid #fff;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:block;margin:12px auto}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <a href="index.html" aria-label="Quay về trang chủ" class="icon-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Quay về trang chủ</a>
        <h1>Thanh toán đơn hàng</h1>
      </div>
    </header>

    <div class="grid">
      <!-- left: form -->
      <div>
        <div class="card" id="checkoutForm">
          <div style="display:flex;gap:12px;flex-direction:column">
            <div id="recipientSelectArea" style="margin-bottom:12px">
              <label for="recipient">Người nhận & Địa chỉ</label>
              <select id="recipient" class="w-full"></select>
              <div class="note" id="addressNote" style="margin-top:6px"></div>
            </div>

            <div>
              <label for="name">Họ và tên</label>
              <input id="name" type="text" placeholder="Họ và tên người nhận" autocomplete="name">
            </div>
            <div>
              <label for="phone">Số điện thoại</label>
              <input id="phone" type="tel" placeholder="Số điện thoại liên hệ" autocomplete="tel">
            </div>
            <div>
              <label for="address">Địa chỉ giao hàng</label>
              <textarea id="address" placeholder="Ví dụ: 123 Nguyễn Trãi, Quận 1, TP.HCM"></textarea>
              <div class="note">Để trống để dùng địa chỉ đã lưu trong tài khoản (nếu có).</div>
            </div>

            <div>
              <label>Phương thức thanh toán</label>
              <div class="payment-methods" role="radiogroup">
                <label class="pay-pill"><input type="radio" name="payment" value="cod" checked> Tiền mặt (COD)</label>
                <label class="pay-pill"><input type="radio" name="payment" value="bank"> Chuyển khoản</label>
                <label class="pay-pill"><input type="radio" name="payment" value="online"> Thanh toán QR</label>
              </div>
            </div>

            <div style="margin-top:12px">
              <button id="placeOrderBtnMobile" class="btn" style="width:100%;">Đặt hàng</button>
            </div>

            <div id="formBankArea" class="card hidden" style="padding:12px; margin-top:12px">
              <div style="font-weight:700">Thông tin chuyển khoản</div>
              <div class="note" style="margin-top:8px">Ngân hàng: <strong>Vietcombank</strong><br>Chủ TK: <strong>WATCHTIME JSC</strong><br>Số TK: <strong>0123456789</strong></div>
              <div style="margin-top:8px">
                <label for="formTransferRef">Ghi chú (mã giao dịch)</label>
                <input id="formTransferRef" placeholder="Ghi chú / Mã đơn hàng">
              </div>
            </div>
          </div>
        </div>

        <div id="mobileOrderArea" style="margin-top:12px"></div>
      </div>

      <aside>
        <div class="card" id="cartCard">
          <h3 style="margin:0 0 8px">Giỏ hàng</h3>
          <div id="cartEmptyNotice" class="empty muted hidden">Giỏ hàng trống</div>
          <div id="cartList" class="cart-list"></div>

          <div id="totalWrap" style="display:none;align-items:center;justify-content:space-between">
            <div style="display:flex;flex-direction:column;align-items:flex-end">
              <div class="total-label">Tổng tiền</div>
              <div class="total-amount" id="totalPrice">0₫</div>
            </div>
            <div style="margin-left:12px"><button id="checkoutBtnDesktop" class="btn">Đặt hàng</button></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
// === Helper cũ: cart, sum, formatVND, inventory ===
const IMPORTS_KEY = 'watchtime_imports';
const ORDERS_KEY = 'allOrders';
const CART_KEY = 'watchtime_cart';
const currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let userData = currentUser ? (JSON.parse(localStorage.getItem(currentUser.email)) || null) : null;

function getStorageData(key, defaultValue = []) {
    try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch(e){ return defaultValue; }
}
function getCart(){ return getStorageData(CART_KEY, []); }
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCartUI(); }
function sumCart(c){ return (c||[]).reduce((s,i)=> s + (Number(i.price)||0)*(i.qty||1),0); }
function formatVND(n){ return Number(n).toLocaleString('vi-VN') + '₫'; }

function calculateAllInventory() {
    const allImports = getStorageData(IMPORTS_KEY, []).filter(i=>i.status==='Đã hoàn thành'); 
    const allOrders = getStorageData(ORDERS_KEY, []).filter(o=>o.status==='Đã giao'); 
    const inventoryMap = new Map();
    const productIdsInCart = getCart().map(i=>i.id);

    productIdsInCart.forEach(id=>{
        let tongNhap=0,tongXuat=0;
        allImports.forEach(imp=>{ const item=imp.items.find(i=>i.productId===id); if(item) tongNhap+=item.qty; });
        allOrders.forEach(order=>{ const item=order.items.find(i=>i.id===id); if(item) tongXuat+=item.qty; });
        inventoryMap.set(id, tongNhap-tongXuat);
    });
    return inventoryMap;
}

// === Render cart ===
function renderCartUI(){
    const cart=getCart();
    const cartList=document.getElementById('cartList');
    const empty=document.getElementById('cartEmptyNotice');
    const totalWrap=document.getElementById('totalWrap');
    const totalPrice=document.getElementById('totalPrice');
    const inventory=calculateAllInventory();
    cartList.innerHTML='';
    if(!cart||cart.length===0){ empty.classList.remove('hidden'); totalWrap.style.display='none'; totalPrice.textContent='0₫'; return; }
    empty.classList.add('hidden');
    cart.forEach((it,idx)=>{
        const div=document.createElement('div'); 
        div.className='cart-item';
        div.innerHTML=`<div class="meta"><div style="font-weight:700">${it.name}</div><div class="muted" style="font-size:13px;margin-top:6px">Mã: ${it.id||''}</div></div>
             <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px"><div class="price">${formatVND(it.price * it.qty)}</div>
             <div style="display:flex;gap:6px;align-items:center"><div class="qty"><button data-action="dec">−</button><div class="count">${it.qty}</div><button data-action="inc">+</button></div><button class="remove-btn">Xóa</button></div></div>`;
        cartList.appendChild(div);

        div.querySelector('[data-action="dec"]').addEventListener('click', ()=>{
            if(it.qty>1){ it.qty--; cart[idx]=it; saveCart(cart); } 
            else if(confirm('Giảm sẽ xóa sản phẩm. Xóa?')){ cart.splice(idx,1); saveCart(cart); }
        });
        div.querySelector('[data-action="inc"]').addEventListener('click', ()=>{ 
            const stock=inventory.get(it.id)||0;
            if(it.qty+1>stock) alert(`Sản phẩm "${it.name}" chỉ còn tối đa ${stock} cái.`);
            else{ it.qty++; cart[idx]=it; saveCart(cart); }
        });
        div.querySelector('.remove-btn').addEventListener('click', ()=>{ if(confirm('Xóa sản phẩm?')){ cart.splice(idx,1); saveCart(cart); }});
    });
    totalPrice.textContent=formatVND(sumCart(cart));
    totalWrap.style.display='flex';
}

// === LOGIC MỚI: QUẢN LÝ ĐỊA CHỈ TỪ NHIỀU TÀI KHOẢN ===
function getAllUsers() {
    const users=[];
    for(let i=0;i<localStorage.length;i++){
        const key=localStorage.key(i);
        if(key.includes('@')) {
            try{
                const user=JSON.parse(localStorage.getItem(key));
                if(user && user.address && user.number && user.firstname && user.lastname){ users.push(user); }
            }catch(e){ continue; }
        }
    }
    return users;
}

function initializeRecipientSelect() {
    const select=document.getElementById('recipient'); if(!select) return;
    select.innerHTML='';
    const allUsers=getAllUsers();
    allUsers.forEach(user=>{
        const option=document.createElement('option');
        option.value=user.email;
        let accountType='Tài khoản phụ';
        if(user.email===currentUser.email) accountType='Địa chỉ của tôi';
        const addressPreview=user.address.length>30 ? user.address.substring(0,30)+'...' : user.address;
        option.textContent=`${accountType}: ${addressPreview} (${user.email})`;
        select.appendChild(option);
    });
    const optionNew=document.createElement('option');
    optionNew.value='new_input';
    optionNew.textContent='Nhập thông tin người nhận mới';
    select.appendChild(optionNew);
    select.value=currentUser ? currentUser.email : 'new_input';
}

function handleRecipientChange() {
    const select=document.getElementById('recipient');
    const val=select.value;
    const nameInput=document.getElementById('name');
    const phoneInput=document.getElementById('phone');
    const addressInput=document.getElementById('address');
    const addressNote=document.getElementById('addressNote');

    nameInput.disabled=phoneInput.disabled=addressInput.disabled=false;

    if(val!=='new_input'){
        const allUsers=getAllUsers();
        const user=allUsers.find(u=>u.email===val);
        if(user){
            const fullName=(user.firstname||'')+(user.lastname?(' '+user.lastname):'');
            nameInput.value=fullName;
            phoneInput.value=user.number||'';
            addressInput.value=user.address||'';
            nameInput.disabled=phoneInput.disabled=addressInput.disabled=true;
            addressNote.textContent=(val===currentUser.email) ? 'Đang sử dụng địa chỉ đã lưu trong TÀI KHOẢN CỦA BẠN.' : `Đang sử dụng địa chỉ đã lưu từ tài khoản phụ (${val}).`;
        }
    }else{
        nameInput.value=phoneInput.value=addressInput.value='';
        addressNote.textContent='Vui lòng nhập đầy đủ thông tin người nhận.';
    }
}

function initializeForm() {
    initializeRecipientSelect();
    handleRecipientChange();
}

function buildOrder(){
    const cart=getCart();
    if(!cart || cart.length===0){ alert('Giỏ hàng rỗng'); return null; }
    const inventory=calculateAllInventory();
    for(const it of cart){
        const stock=inventory.get(it.id)||0;
        if(it.qty>stock){ alert(`Sản phẩm "${it.name}" không đủ tồn kho (${stock}).`); return null; }
    }
    const name=document.getElementById('name').value.trim();
    const phone=document.getElementById('phone').value.trim();
    let address=document.getElementById('address').value.trim();
    if(!address && userData && userData.address) address=userData.address;
    if(!name || !phone || !address){ alert('Vui lòng nhập đầy đủ Họ tên, SĐT và Địa chỉ.'); return null; }
    const pm=document.querySelector('input[name="payment"]:checked').value;
    return { id:'ORD'+Date.now(), userEmail:currentUser?currentUser.email:'guest', customer:{name,phone,address}, items:cart.map(i=>({...i})), total:sumCart(cart), paymentMethod:pm, status:'Mới đặt', orderDate:new Date().toISOString() };
}

document.addEventListener('DOMContentLoaded', ()=>{
    if(!currentUser){ alert("Vui lòng đăng nhập!"); window.location.href="dangnhap.html"; return; }
    renderCartUI();
    initializeForm();
    document.getElementById('checkoutBtnDesktop')?.addEventListener('click', ()=>{ const o=buildOrder(); if(!o) return; console.log(o); });
    document.getElementById('placeOrderBtnMobile')?.addEventListener('click', ()=>{ const o=buildOrder(); if(!o) return; console.log(o); });
    document.getElementById('recipient')?.addEventListener('change', handleRecipientChange);
});
</script>
</body>
</html>
